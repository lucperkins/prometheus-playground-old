# haproxy sandbox

In this sandbox, [HAProxy](http://www.haproxy.org/) acts as a reverse proxy for Prometheus, enforcing both [TLS encryption](https://prometheus.io/docs/guides/tls-encryption) and [basic auth](https://prometheus.io/docs/guides/basic-auth). All Prometheus endpoints are available behind https://example.com/prometheus. The [expression browser](https://prometheus.io/docs/visualization/browser), for example, is available at https://example.com/prometheus/graph.

> To access Prometheus in this sandbox, two username/password combos are possible: `admin1`/`password1` and `admin2`/`password2`.

## Usage

To start the sandbox:

```bash
# In the foreground
make run # docker-compose up --build

# In detached mode
make run-detached # docker-compose up --build --detach
```

This will start up an `haproxy` container and a `prometheus` container.

The `haproxy` container is available on `localhost` port 443 but the example will only work if you map `localhost` to `example.com`. You can do so by modifying your `/etc/hosts` file to include a line like this:

```conf
127.0.0.1     localhost example.com
```

As HAProxy enforces both TLS encryption and basic auth, this will result in a self-signed certificate error:

```bash
curl https://example.com/prometheus/metrics
```

If you disable cert checking using `--insecure`/`-k` you'll get a `401 Unauthorized` error:

```bash
curl -ik https://example.com/prometheus/graph
```

You'll need to supply an valid username and password to access Prometheus through the proxy:

```bash
curl -ik -u admin1:password1 https://example.com/prometheus/metrics
```

Open up `https://admin1:password1@example.com/prometheus/graph` to access the Prometheus [expression browser](https://prometheus.io/docs/visualization/browser).

## Assets

Folder | Assets
:------|:------
[`certs`](./certs) | An SSL cert and key generated by [OpenSSL](https://www.openssl.org/)
[`haproxy`](./haproxy) | An [`haproxy.cfg`](./haproxy/haproxy.cfg) configuration file
[`prometheus`](./prometheus) | A [`prometheus.yml`](./prometheus/prometheus.yml) configuration file for Prometheus

The haproxy cert was created using these commands:

```bash
openssl req -newkey rsa:4096 -nodes -keyout certs/key.pem -x509 -out certs/certificate.pem \
    -subj "/C=US/ST=OR/L=Portland/O=CNCF/OU=Developer advocacy/CN=example.com"
cat certs/{certificate,key}.pem > certs/cert.pem
rm certs/{certificate,key}.pem
```

The hashed passwords in [`haproxy.cfg`](./haproxy/haproxy.cfg) were created using these commands:

```bash
mkpasswd -m sha-512 password1
mkpasswd -m sha-512 password2
```